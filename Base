<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INIAD MULTI-CONSOLE V8.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --blue: #004098; --orange: #e67e22; --bg: #e0e0e0; --frame: #333; }
        body { background: var(--bg); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        #console-frame { background: var(--frame); width: 95%; max-width: 600px; min-height: 95vh; margin: 10px; border-radius: 20px; border-bottom: 8px solid #222; padding: 20px; box-sizing: border-box; color: white; box-shadow: 0 10px 40px rgba(0,0,0,0.4); position: relative;}
        .screen { background: #fff; border-radius: 10px; color: #333; padding: 15px; min-height: 540px; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); overflow-y: auto; }
        .hidden { display: none !important; }
        .btn { padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; width: 100%; margin: 8px 0; font-size: 1rem; transition: 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: var(--blue); color: #fff; }
        .btn-orange { background: var(--orange); color: #fff; }
        .btn-gray { background: #eee; color: #333; border: 1px solid #ccc; }
        /* Ito UI */
        .ito-card { width: 45px; height: 65px; border: 2px solid var(--blue); border-radius: 5px; display: inline-flex; flex-direction: column; justify-content: center; align-items: center; margin: 2px; font-weight: bold; background: white; }
        .hand-area { width: 80px; height: 110px; background: var(--blue); color: white; margin: 10px auto; border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; font-size: 0.8rem; }
        .num-view { position: absolute; width: 100%; height: 100%; background: #fff; border: 3px solid var(--blue); border-radius: 10px; color: var(--blue); font-size: 2.5rem; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.1s;}
        .hand-area:active .num-view { opacity: 1; }
        /* Decrypto UI */
        .kw-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .kw-box { border: 1px solid var(--blue); padding: 10px 2px; border-radius: 5px; font-size: 0.75rem; background: #f9f9f9; text-align: center; font-weight: bold; }
        .log-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; margin-top: 15px; }
        .log-table th, .log-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .reset-link { font-size: 0.7rem; color: #999; margin-top: 20px; cursor: pointer; text-decoration: underline; display: block; text-align: center; }
    </style>
</head>
<body>

<div id="console-frame">
    <div style="text-align:center; margin-bottom:10px; font-weight:bold; font-size: 0.7rem;">INIAD MULTI-CONSOLE V8.0</div>
    <div class="screen">
        <div id="view-login">
            <h2 style="text-align:center; margin-top:60px;">SYSTEM BOOT</h2>
            <input type="text" id="in-name" class="btn btn-gray" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="box-sizing: border-box;">
            <button onclick="Core.login()" class="btn btn-blue">START</button>
        </div>
        <div id="view-portal" class="hidden">
            <p id="u-display" style="font-weight:bold; color:var(--blue); border-bottom:1px solid #ddd; padding-bottom:5px;">User: ---</p>
            <button onclick="Core.loadGame('ito')" class="btn btn-blue">ğŸƒ Ito (100 Themes)</button>
            <button onclick="Core.loadGame('de')" class="btn btn-orange">ğŸ”’ Decrypto</button>
        </div>
        <div id="view-game" class="hidden">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
                <button onclick="Core.eject()" style="border:none; background:none; cursor:pointer; color:#888;">â—€ EJECT</button>
                <div id="game-tag" style="background:#eee; font-size:0.7rem; padding:2px 10px; border-radius:10px; font-weight:bold;"></div>
            </div>
            <div id="game-content"></div>
        </div>
    </div>
</div>

<script>
// --- CORE SYSTEM ---
const firebaseConfig = { databaseURL: "https://noyu-d5611-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const Core = {
    user: "", currentGame: null,
    login() {
        this.user = document.getElementById('in-name').value.trim();
        if(!this.user) return;
        document.getElementById('u-display').innerText = "User: " + this.user;
        this.show('view-portal');
    },
    show(id) {
        ['view-login', 'view-portal', 'view-game'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    },
    loadGame(gid) {
        this.currentGame = gid;
        document.getElementById('game-tag').innerText = gid.toUpperCase();
        this.show('view-game');
        if(gid==='ito') Ito.init(); else Decrypto.init();
    },
    eject() {
        db.ref(this.currentGame).off();
        this.currentGame = null;
        this.show('view-portal');
    }
};

// --- ITO LOGIC ---
const Ito = {
    myNum: 0,
    themes: [
        {n:"ã‚³ãƒ³ãƒ“ãƒ‹å•†å“", s:"1:å®‰ã„ â†” 100:é«˜ã„"}, {n:"æ­¦å™¨ã®å¼·ã•", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"æ€–ã„ã‚‚ã®", s:"1:æ€–ããªã„ â†” 100:æ€–ã„"}, {n:"ãƒ¢ãƒ†ã‚‹è¶£å‘³", s:"1:ãƒ¢ãƒ†ãªã„ â†” 100:ãƒ¢ãƒ†ã‚‹"}, {n:"ãªã‚ŠãŸã„è·æ¥­", s:"1:ä¸äººæ°— â†” 100:äººæ°—"},
        {n:"æ¬²ã—ã„è¶…èƒ½åŠ›", s:"1:åœ°å‘³ â†” 100:æœ€å¼·"}, {n:"ãƒ‡ãƒ¼ãƒˆå ´æ‰€", s:"1:æœ€æ‚ª â†” 100:æœ€é«˜"}, {n:"æœ€å¼·ã®å‹•ç‰©", s:"1:å¼±ã„ â†” 100:å¼·ã„"}, {n:"æ³£ã‘ã‚‹æ˜ ç”»", s:"1:ç¬‘ãˆã‚‹ â†” 100:å·æ³£"}, {n:"ä½ã¿ãŸã„å ´æ‰€", s:"1:å«Œ â†” 100:ç†æƒ³"},
        {n:"è²°ã£ã¦å¬‰ã—ã„ç‰©", s:"1:å›°ã‚‹ â†” 100:å¬‰ã—ã„"}, {n:"ä¸€ç”Ÿé£Ÿã¹ãŸã„ç‰©", s:"1:å«Œ â†” 100:ç†æƒ³"}, {n:"ä¾¿åˆ©ãªå®¶é›»", s:"1:ä½ã„ â†” 100:é«˜ã„"}, {n:"æ­´å²äººç‰©ã®å‡„ã•", s:"1:åœ°å‘³ â†” 100:è¡æ’ƒ"}, {n:"è‡ªåˆ†ã¸ã®ã”è¤’ç¾", s:"1:è³ªç´  â†” 100:è±ªè¯"}
        /* ... ä»–ã®ãƒ†ãƒ¼ãƒã‚‚åŒæ§˜ã«çµ±åˆ ... */
    ],
    init() {
        document.getElementById('game-content').innerHTML = `
            <div id="ito-setup"><h3>THEME SELECT</h3><button onclick="Ito.suggest()" class="btn btn-orange">ãŠé¡Œã‚’å‡ºã™</button><div id="ito-opts"></div></div>
            <div id="ito-play" class="hidden">
                <div style="background:#f0f7ff; border:2px solid var(--blue); border-radius:10px; padding:10px; margin-bottom:15px;">
                    <h2 id="it-n" style="text-align:center; margin:0; color:var(--blue);"></h2>
                    <p id="it-s" style="text-align:center; font-size:0.9rem; font-weight:bold; margin:5px 0 0 0; color:#333;"></p>
                </div>
                <div id="it-field" style="text-align:center; min-height:80px;"></div>
                <div id="it-msg" style="text-align:center; font-weight:bold; margin:10px;"></div>
                <div class="hand-area"><div id="it-mynum" class="num-view">?</div>HOLD</div>
                <button id="it-draw" onclick="Ito.draw()" class="btn btn-blue">æ•°å­—ã‚’å¼•ã</button>
                <button id="it-sub" onclick="Ito.submit()" class="btn btn-orange hidden">ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
            </div>
            <span onclick="Ito.reset()" class="reset-link">HARD RESET</span>`;
        db.ref('ito').on('value', snap => {
            const d = snap.val() || {};
            if(d.config) {
                document.getElementById('ito-setup').classList.add('hidden'); document.getElementById('ito-play').classList.remove('hidden');
                document.getElementById('it-n').innerText = d.config.theme; document.getElementById('it-s').innerText = d.config.scale;
            } else {
                document.getElementById('ito-setup').classList.remove('hidden'); document.getElementById('ito-play').classList.add('hidden');
                document.getElementById('ito-opts').innerHTML = (d.proposals||[]).map((p,i)=>`<button class="btn btn-gray" onclick="Ito.select(${i})">${p.n}</button>`).join('');
            }
            const f = document.getElementById('it-field'); f.innerHTML = "";
            if(d.cards) {
                let last=0, fail=false;
                Object.values(d.cards).sort((a,b)=>a.ts-b.ts).forEach(c => {
                    if(c.num < last) fail = true;
                    f.innerHTML += `<div class="ito-card" style="border-color:${fail?'red':'#004098'}"><span>${c.num}</span><small style="font-size:0.5rem;">${c.user}</small></div>`;
                    last = c.num;
                });
                document.getElementById('it-msg').innerText = fail ? "FAILED" : "STABLE";
            }
        });
    },
    suggest() { db.ref('ito/proposals').set(this.themes.sort(()=>0.5-Math.random()).slice(0,3)); },
    select(i) { db.ref('ito/proposals').once('value', s=>{ const p=s.val(); if(p) db.ref('ito/config').set({theme:p[i].n, scale:p[i].s}); }); },
    draw() { this.myNum = Math.floor(Math.random()*100)+1; document.getElementById('it-mynum').innerText = this.myNum; document.getElementById('it-draw').classList.add('hidden'); document.getElementById('it-sub').classList.remove('hidden'); },
    submit() { db.ref('ito/cards').push({num:this.myNum, user:Core.user, ts:Date.now()}); document.getElementById('it-sub').classList.add('hidden'); },
    reset() { if(confirm("RESET?")) db.ref('ito').remove(); }
};

// --- DECRYPTO LOGIC ---
const Decrypto = {
    role: "", isJudging: false,
    wordsList: ["å­¦æ ¡","ãƒªãƒ³ã‚´","å®‡å®™","ã‚®ã‚¿ãƒ¼","ã‚«ãƒ¡ãƒ©","å¯¿å¸","é›»è©±","æµ·","å±±","æ™‚è¨ˆ","æœ¬","é³¥","èŠ±","é´","æ¤…å­","ã‚«ãƒ¬ãƒ¼","é›»è»Š","å…¬åœ’","ãƒ”ã‚¢ãƒ","å¤ªé™½","ç ‚æ¼ ","å†·è”µåº«","çœ¼é¡","æœˆ","æ˜ ç”»","é‡çƒ","ãƒ©ãƒ¼ãƒ¡ãƒ³","ç§˜å¯†","ãŠé¢¨å‘‚","éµ"],
    init() {
        document.getElementById('game-content').innerHTML = `
            <div id="de-ui">
                <h3 id="de-r-view" style="text-align:center;">Round -</h3>
                <div id="de-roles"><button onclick="Decrypto.setRole('W')" class="btn btn-blue">ç™½ï¼ˆå‘³æ–¹ï¼‰ã«å‚åŠ  (<span id="cw">0</span>)</button><button onclick="Decrypto.setRole('B')" class="btn btn-orange">é»’ï¼ˆæ•µï¼‰ã«å‚åŠ  (<span id="cb">0</span>)</button></div>
                <div id="de-board" class="hidden">
                    <div id="de-info" style="font-size:0.75rem; font-weight:bold; color:var(--blue); margin-bottom:10px;"></div>
                    <div class="kw-grid"><div class="kw-box" id="dw1">?</div><div class="kw-box" id="dw2">?</div><div class="kw-box" id="dw3">?</div><div class="kw-box" id="dw4">?</div></div>
                    <div id="de-ctrl" style="padding:15px; background:#f4f4f4; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;"></div>
                    <table class="log-table"><thead><tr><th>R</th><th>ãƒ’ãƒ³ãƒˆ</th><th>æ­£è§£</th><th>çµæœ (ç™½/é»’)</th></tr></thead><tbody id="de-log"></tbody></table>
                </div>
                <span onclick="Decrypto.reset()" class="reset-link">HARD RESET</span>
            </div>`;
        this.listen();
    },
    listen() {
        db.ref('de').on('value', snap => {
            const d = snap.val() || {};
            if(!d.words) { db.ref('de/words').set(this.wordsList.sort(()=>0.5-Math.random()).slice(0,4)); return; }
            const wT = d.roles?.W ? Object.values(d.roles.W) : [];
            const bT = d.roles?.B ? Object.values(d.roles.B) : [];
            this.role = wT.includes(Core.user) ? "W" : (bT.includes(Core.user) ? "B" : "");
            document.getElementById('cw').innerText = wT.length;
            document.getElementById('cb').innerText = bT.length;
            if(!this.role) return;
            document.getElementById('de-roles').classList.add('hidden');
            document.getElementById('de-board').classList.remove('hidden');
            const round = (d.logs ? Object.keys(d.logs).length : 0) + 1;
            document.getElementById('de-r-view').innerText = `Round ${round}`;
            d.words.forEach((w,i)=> { document.getElementById('dw'+(i+1)).innerText = (this.role==='B' ? (i+1) : (i+1)+': '+w); });
            const maker = wT[(round - 1) % wT.length] || wT[0];
            document.getElementById('de-info').innerText = `ãƒãƒ¼ãƒ : ${this.role==='W'?'ç™½':'é»’'} / è¦ª: ${maker}`;
            const ctrl = document.getElementById('de-ctrl');
            if(!d.hints) {
                if(this.role==='W' && Core.user === maker) {
                    let activeCode = d.code;
                    if(!activeCode) { activeCode = [1,2,3,4].sort(()=>0.5-Math.random()).slice(0,3).join(''); db.ref('de/code').set(activeCode); }
                    ctrl.innerHTML = `ã‚ãªãŸã®æš—å·: <b style="font-size:1.8rem; color:var(--orange);">${activeCode}</b><br>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input id="h1" class="btn btn-gray" placeholder="H1" style="flex:1" onkeydown="if(event.key==='Enter')document.getElementById('h2').focus()">
                            <input id="h2" class="btn btn-gray" placeholder="H2" style="flex:1" onkeydown="if(event.key==='Enter')document.getElementById('h3').focus()">
                            <input id="h3" class="btn btn-gray" placeholder="H3" style="flex:1" onkeydown="if(event.key==='Enter')document.getElementById('btn-send').focus()">
                        </div><button id="btn-send" onclick="Decrypto.sendH()" class="btn btn-orange">ãƒ’ãƒ³ãƒˆé€ä¿¡</button>`;
                } else { ctrl.innerHTML = `<center style="color:#888;">${maker} ãŒä½œæˆä¸­...</center>`; }
            } else {
                if(this.role==='W' && Core.user!==maker && !d.ansW) {
                    ctrl.innerHTML = `ãƒ’ãƒ³ãƒˆ: <b>${d.hints}</b><br><input id="ain" type="number" class="btn btn-gray" placeholder="3æ¡å›ç­”" onkeydown="if(event.key==='Enter')Decrypto.sendA('W')"><button onclick="Decrypto.sendA('W')" class="btn btn-blue">å‘³æ–¹ã«é€ä¿¡</button>`;
                } else if(this.role==='B' && !d.ansB) {
                    ctrl.innerHTML = `ãƒ’ãƒ³ãƒˆ: <b>${d.hints}</b><br><input id="ain" type="number" class="btn btn-gray" placeholder="3æ¡å‚å—" onkeydown="if(event.key==='Enter')Decrypto.sendA('B')"><button onclick="Decrypto.sendA('B')" class="btn btn-orange">å‚å—æ”»æ’ƒ</button>`;
                } else { ctrl.innerHTML = `ãƒ’ãƒ³ãƒˆ: <b>${d.hints}</b><br><div style="text-align:center; font-size:0.7rem;">å¾…æ©Ÿä¸­ (ç™½:${d.ansW?'OK':'-'} é»’:${d.ansB?'OK':'-'})</div>`; }
                if(d.ansW && d.ansB && Core.user===maker && d.code && !this.isJudging) { this.isJudging = true; this.judge(round, d); }
            }
            const lb = document.getElementById('de-log'); lb.innerHTML = "";
            if(d.logs) Object.values(d.logs).reverse().forEach(l => {
                lb.innerHTML += `<tr style="background:${l.resB==='æˆåŠŸ'?'#fff3e0':(l.resW==='æˆåŠŸ'?'#e3f2fd':'#f9f9f9')}"><td>${l.r}</td><td>${l.h}</td><td>${l.c}</td><td style="font-size:0.6rem;">ç™½:${l.ansW}(${l.resW})<br>é»’:${l.ansB}(${l.resB})</td></tr>`;
            });
        });
    },
    setRole(r) { db.ref(`de/roles/${r}/${Core.user}`).set(Core.user); },
    sendH() { const h1=document.getElementById('h1').value, h2=document.getElementById('h2').value, h3=document.getElementById('h3').value; if(h1&&h2&&h3) db.ref('de/hints').set(`${h1} / ${h2} / ${h3}`); },
    sendA(t) { const v=document.getElementById('ain').value; if(v.length===3) db.ref('de/ans'+t).set(v); },
    judge(r, d) {
        const bOk=(String(d.ansB)===String(d.code)), wOk=(String(d.ansW)===String(d.code));
        const up={}; up[`de/logs/r${Date.now()}`]={r:r,h:d.hints,c:d.code,ansW:d.ansW,resW:wOk?"æˆåŠŸ":"å¤±æ•—",ansB:d.ansB,resB:bOk?"æˆåŠŸ":"å¤±æ•—"};
        up[`de/hints`]=null; up[`de/ansW`]=null; up[`de/ansB`]=null; up[`de/code`]=null;
        db.ref().update(up).then(()=>this.isJudging=false);
    },
    reset() { if(confirm("RESET?")) db.ref('de').remove(); }
};
</script>
</body>
</html>
